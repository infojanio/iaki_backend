generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model State {
  id        String   @id @default(uuid())
  name      String
  uf        String   @unique
  createdAt DateTime @default(now())
  cities    City[]

  @@map("states")
}

model City {
  id                 String                 @id @default(uuid())
  name               String
  stateId            String                 @map("state_id")
  createdAt          DateTime               @default(now())
  businessCategories BusinessCategoryCity[]
  state              State                  @relation(fields: [stateId], references: [id])
  stores             Store[]
  users              User[]

  @@unique([name, stateId])
  @@map("cities")
}

model User {
  id                      String                   @id @default(uuid())
  name                    String
  email                   String                   @unique
  passwordHash            String                   @map("password_hash")
  phone                   String?
  cpf                     String?
  role                    Role                     @default(USER)
  avatar                  String?
  storeId                 String?
  street                  String?
  cityId                  String?
  state                   String?
  postalCode              String?                  @map("postal_code")
  createdAt               DateTime                 @default(now()) @map("created_at")
  carts                   Cart[]
  cashbackTx              CashbackTransaction[]
  cashbacks               Cashback[]
  checkIns                CheckIn[]
  couponRedemptions       CouponRedemption[]
  missionProgresses       MissionProgress[]
  orders                  Order[]
  refreshTokens           RefreshToken[]
  evaluations             StoreEvaluation[]
  locations               UserLocation[]
  city                    City?                    @relation(fields: [cityId], references: [id])
  store                   Store?                   @relation(fields: [storeId], references: [id])
  storePointsWallets      StorePointsWallet[]
  storePointsTransactions StorePointsTransaction[]
  storeRewardRedemptions  StoreRewardRedemption[]

  @@map("users")
}

model Subscription {
  id        String             @id @default(uuid())
  storeId   String             @map("store_id")
  planId    String             @map("plan_id")
  status    SubscriptionStatus @default(ACTIVE)
  startAt   DateTime           @default(now()) @map("start_at")
  endAt     DateTime           @map("end_at")
  renewedAt DateTime?          @map("renewed_at")
  createdAt DateTime           @default(now()) @map("created_at")
  plan      Plan               @relation(fields: [planId], references: [id])
  store     Store              @relation(fields: [storeId], references: [id])

  @@map("subscriptions")
}

model BusinessCategory {
  id        String                  @id @default(uuid())
  name      String                  @unique
  image     String?
  createdAt DateTime                @default(now()) @map("created_at")
  cities    BusinessCategoryCity[]
  stores    StoreBusinessCategory[]

  @@map("business_categories")
}

model BusinessCategoryCity {
  id                 String           @id @default(uuid())
  businessCategoryId String           @map("business_category_id")
  cityId             String           @map("city_id")
  businessCategory   BusinessCategory @relation(fields: [businessCategoryId], references: [id], onDelete: Cascade)
  city               City             @relation(fields: [cityId], references: [id], onDelete: Cascade)

  @@unique([businessCategoryId, cityId])
  @@map("business_category_cities")
}

model StoreBusinessCategory {
  id         String           @id @default(uuid())
  storeId    String           @map("store_id")
  categoryId String           @map("category_id")
  category   BusinessCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  store      Store            @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([storeId, categoryId])
  @@map("store_business_categories")
}

model Store {
  id                      String                   @id @default(uuid())
  name                    String
  slug                    String?                  @unique
  isActive                Boolean                  @default(true)
  rating                  Float                    @default(0)
  ratingCount             Int                      @default(0)
  latitude                Decimal
  longitude               Decimal
  phone                   String?
  cnpj                    String?
  avatar                  String?
  street                  String?
  postalCode              String?                  @map("postal_code")
  cityId                  String                   @map("city_id")
  createdAt               DateTime                 @default(now()) @map("created_at")
  banners                 Banner[]
  carts                   Cart[]
  cashbackTx              CashbackTransaction[]
  cashbacks               Cashback[]
  checkIns                CheckIn[]
  coupons                 Coupon[]
  orders                  Order[]
  products                Product[]
  storeBusinessCategories StoreBusinessCategory[]
  storeCategories         StoreCategory[]
  storeDiscounts          StoreDiscount[]
  evaluations             StoreEvaluation[]
  city                    City                     @relation(fields: [cityId], references: [id])
  subscriptions           Subscription[]
  users                   User[]
  paymentTypes            PaymentType[]            @relation("PaymentTypeToStore")
  storePointsWallets      StorePointsWallet[]
  storePointsTransactions StorePointsTransaction[]
  storeRewards            StoreReward[]
  storeDraws              StoreDraw[]
  storeRewardRedemptions  StoreRewardRedemption[]

  @@map("stores")
}

model Category {
  id            String          @id @default(uuid())
  name          String          @unique
  image         String?
  createdAt     DateTime        @default(now()) @map("created_at")
  stores        StoreCategory[]
  subcategories SubCategory[]

  @@map("categories")
}

model SubCategory {
  id         String    @id @default(uuid())
  name       String
  image      String?
  categoryId String    @map("category_id")
  createdAt  DateTime  @default(now()) @map("created_at")
  products   Product[]
  category   Category  @relation(fields: [categoryId], references: [id])

  @@map("subcategories")
}

model StoreCategory {
  id         String   @id @default(uuid())
  storeId    String   @map("store_id")
  categoryId String   @map("category_id")
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  store      Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([storeId, categoryId])
  @@map("store_categories")
}

model Product {
  id                 String      @id @default(uuid())
  name               String
  description        String?
  price              Decimal
  quantity           Decimal
  minStock           Int         @default(5)
  image              String?
  status             Boolean     @default(true)
  cashbackPercentage Float       @default(0.0) @map("cashback_percentage")
  storeId            String      @map("store_id")
  subcategoryId      String      @map("subcategory_id")
  createdAt          DateTime    @default(now()) @map("created_at")
  cartItems          CartItem[]
  orderItems         OrderItem[]
  store              Store       @relation(fields: [storeId], references: [id])
  subcategory        SubCategory @relation(fields: [subcategoryId], references: [id])

  @@map("products")
}

model Cart {
  id        String     @id @default(uuid())
  userId    String     @map("user_id")
  storeId   String     @map("store_id")
  status    CartStatus @default(OPEN)
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")
  items     CartItem[]
  store     Store      @relation(fields: [storeId], references: [id])
  user      User       @relation(fields: [userId], references: [id])

  @@map("carts")
}

model CartItem {
  id               String   @id @default(uuid())
  cartId           String   @map("cart_id")
  productId        String   @map("product_id")
  quantity         Int
  priceSnapshot    Decimal  @map("price_snapshot")
  cashbackSnapshot Decimal  @map("cashback_snapshot")
  createdAt        DateTime @default(now()) @map("created_at")
  cart             Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product          Product  @relation(fields: [productId], references: [id])

  @@unique([cartId, productId])
  @@map("cart_items")
}

model Order {
  id                      String                   @id @default(uuid())
  userId                  String                   @map("user_id")
  storeId                 String                   @map("store_id")
  totalAmount             Decimal                  @map("total_amount")
  discountApplied         Decimal                  @default(0) @map("discount_applied")
  validatedAt             DateTime?                @map("validated_at")
  qrCodeUrl               String?
  status                  OrderStatus              @default(PENDING)
  createdAt               DateTime                 @default(now()) @map("created_at")
  cashbackTx              CashbackTransaction[]
  cashbacks               Cashback[]
  couponRedemptions       CouponRedemption[]
  items                   OrderItem[]
  store                   Store                    @relation(fields: [storeId], references: [id])
  user                    User                     @relation(fields: [userId], references: [id])
  storePointsTransactions StorePointsTransaction[]

  @@map("orders")
}

model OrderItem {
  id        String  @id @default(uuid())
  orderId   String  @map("order_id")
  productId String  @map("product_id")
  quantity  Decimal
  subtotal  Decimal
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product   Product @relation(fields: [productId], references: [id])

  @@map("order_items")
}

model Cashback {
  id         String         @id @default(uuid())
  userId     String         @map("user_id")
  storeId    String         @map("store_id")
  orderId    String?
  amount     Decimal
  validated  Boolean        @default(false)
  creditedAt DateTime
  status     CashbackStatus @default(PENDING)
  order      Order?         @relation(fields: [orderId], references: [id])
  store      Store          @relation(fields: [storeId], references: [id])
  user       User           @relation(fields: [userId], references: [id])

  @@map("cashbacks")
}

model CashbackTransaction {
  id        String                  @id @default(uuid())
  userId    String                  @map("user_id")
  storeId   String                  @map("store_id")
  orderId   String?
  amount    Decimal
  type      CashbackTransactionType
  createdAt DateTime                @default(now()) @map("created_at")
  order     Order?                  @relation(fields: [orderId], references: [id])
  store     Store                   @relation(fields: [storeId], references: [id])
  user      User                    @relation(fields: [userId], references: [id])

  @@map("cashback_transactions")
}

model Banner {
  id        String   @id @default(uuid())
  title     String
  imageUrl  String
  link      String?
  isActive  Boolean  @default(true)
  position  Int?
  storeId   String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  store     Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@map("banners")
}

model Reel {
  id         String   @id @default(uuid())
  title      String
  image_url  String
  link       String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("reels")
}

model CheckIn {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  storeId   String   @map("store_id")
  latitude  Float?
  longitude Float?
  createdAt DateTime @default(now()) @map("created_at")
  store     Store    @relation(fields: [storeId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@map("checkins")
}

model Coupon {
  id          String             @id @default(uuid())
  code        String             @unique
  storeId     String             @map("store_id")
  type        CouponType
  value       Decimal
  minValue    Decimal?
  usageLimit  Int?
  usedCount   Int                @default(0)
  validFrom   DateTime
  validTo     DateTime
  isActive    Boolean            @default(true)
  createdAt   DateTime           @default(now()) @map("created_at")
  updatedAt   DateTime           @updatedAt @map("updated_at")
  redemptions CouponRedemption[]
  store       Store              @relation(fields: [storeId], references: [id])

  @@map("coupons")
}

model CouponRedemption {
  id        String   @id @default(uuid())
  couponId  String   @map("coupon_id")
  userId    String   @map("user_id")
  orderId   String?
  createdAt DateTime @default(now()) @map("created_at")
  coupon    Coupon   @relation(fields: [couponId], references: [id])
  order     Order?   @relation(fields: [orderId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@map("coupon_redemptions")
}

model StoreDiscount {
  id          String       @id @default(uuid())
  storeId     String       @map("store_id")
  type        DiscountType
  value       Decimal
  title       String?
  description String?
  validFrom   DateTime?
  validTo     DateTime?
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")
  store       Store        @relation(fields: [storeId], references: [id])

  @@map("store_discounts")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id])

  @@map("refresh_tokens")
}

model UserLocation {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  latitude  Float
  longitude Float
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id])

  @@map("user_locations")
}

model Mission {
  id          String            @id @default(uuid())
  title       String
  description String?
  type        MissionType
  target      Int
  rewardType  RewardType
  rewardValue Decimal?
  isActive    Boolean           @default(true)
  createdAt   DateTime          @default(now()) @map("created_at")
  progresses  MissionProgress[]

  @@map("missions")
}

model MissionProgress {
  id          String    @id @default(uuid())
  missionId   String    @map("mission_id")
  userId      String    @map("user_id")
  progress    Int       @default(0)
  completed   Boolean   @default(false)
  completedAt DateTime?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  mission     Mission   @relation(fields: [missionId], references: [id])
  user        User      @relation(fields: [userId], references: [id])

  @@unique([missionId, userId])
  @@map("mission_progresses")
}

model StoreEvaluation {
  id        String   @id @default(uuid())
  storeId   String   @map("store_id")
  userId    String   @map("user_id")
  rating    Int
  createdAt DateTime @default(now()) @map("created_at")
  store     Store    @relation(fields: [storeId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([storeId, userId])
  @@map("store_evaluations")
}

model PaymentType {
  id        String   @id @default(uuid())
  type      String
  createdAt DateTime @default(now()) @map("created_at")
  stores    Store[]  @relation("PaymentTypeToStore")

  @@map("payment_types")
}

model Plan {
  id            String         @id
  name          String
  price         Decimal
  productLimit  Int
  storeLimit    Int
  userLimit     Int
  description   String?
  created_at    DateTime       @default(now())
  subscriptions Subscription[]
}

model StorePointsWallet {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  storeId   String   @map("store_id")
  balance   Int      @default(0)
  earned    Int      @default(0)
  spent     Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  transactions StorePointsTransaction[]

  @@unique([userId, storeId])
  @@map("store_points_wallets")
}

model StorePointsTransaction {
  id        String            @id @default(uuid())
  userId    String            @map("user_id")
  storeId   String            @map("store_id")
  orderId   String?           @map("order_id")
  type      StorePointsTxType
  points    Int
  note      String?
  createdAt DateTime          @default(now()) @map("created_at")

  user                User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  store               Store              @relation(fields: [storeId], references: [id], onDelete: Cascade)
  order               Order?             @relation(fields: [orderId], references: [id], onDelete: SetNull)
  storePointsWallet   StorePointsWallet? @relation(fields: [storePointsWalletId], references: [id])
  storePointsWalletId String?

  @@index([userId, storeId])
  @@map("store_points_transactions")
}

model StoreReward {
  id          String    @id @default(uuid())
  storeId     String    @map("store_id")
  title       String
  description String?
  pointsCost  Int       @map("points_cost")
  stock       Int       @default(0)
  isActive    Boolean   @default(true)
  image       String?
  expiresAt   DateTime?
  maxPerUser  Int?
  createdAt   DateTime  @default(now()) @map("created_at")

  store                  Store                   @relation(fields: [storeId], references: [id], onDelete: Cascade)
  storeRewardRedemptions StoreRewardRedemption[]

  @@map("store_rewards")
}

model StoreRewardRedemption {
  id        String           @id @default(uuid())
  rewardId  String           @map("reward_id")
  userId    String           @map("user_id")
  storeId   String           @map("store_id")
  points    Int
  status    RedemptionStatus @default(PENDING)
  createdAt DateTime         @default(now()) @map("created_at")
  usedAt    DateTime?

  reward StoreReward @relation(fields: [rewardId], references: [id])
  user   User        @relation(fields: [userId], references: [id])
  store  Store       @relation(fields: [storeId], references: [id])

  @@map("store_reward_redemptions")
}

enum RedemptionStatus {
  PENDING
  CONFIRMED
  CANCELED
}

model StoreDraw {
  id             String   @id @default(uuid())
  storeId        String   @map("store_id")
  title          String
  description    String?
  pointsPerEntry Int      @map("points_per_entry")
  startsAt       DateTime @map("starts_at")
  endsAt         DateTime @map("ends_at")
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now()) @map("created_at")

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@map("store_draws")
}

enum StorePointsTxType {
  EARN
  SPEND
  ADJUST
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  EXPIRED
}

enum CartStatus {
  OPEN
  CHECKED_OUT
  CLOSED
}

enum CashbackStatus {
  PENDING
  CONFIRMED
  CANCELED
}

enum CashbackTransactionType {
  RECEIVE
  USE
}

enum Role {
  USER
  ADMIN
  SUPER_ADMIN
}

enum OrderStatus {
  PENDING
  VALIDATED
  EXPIRED
}

enum DiscountType {
  FIXED
  DAILY
  WEEKLY
}

enum CouponType {
  PERCENT
  FIXED
  CONDITIONAL
}

enum MissionType {
  CHECKIN
  ORDERS_COUNT
  ORDERS_VALUE
  COUPONS_USED
}

enum RewardType {
  COUPON
  DISCOUNT
}
