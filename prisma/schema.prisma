///////////////////////////////////////////////////////////////
// GENERATOR & DATASOURCE
///////////////////////////////////////////////////////////////

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

///////////////////////////////////////////////////////////////
// STATES & CITIES
///////////////////////////////////////////////////////////////

model State {
  id        String   @id @default(uuid())
  name      String
  uf        String   @unique
  createdAt DateTime @default(now())

  cities City[]

  @@map("states")
}

model City {
  id        String   @id @default(uuid())
  name      String
  stateId   String   @map("state_id")
  state     State    @relation(fields: [stateId], references: [id])
  createdAt DateTime @default(now())

  users  User[]
  stores Store[]

  businessCategories BusinessCategoryCity[]

  @@unique([name, stateId])
  @@map("cities")
}

///////////////////////////////////////////////////////////////
// USERS
///////////////////////////////////////////////////////////////

model User {
  id           String  @id @default(uuid())
  name         String
  email        String  @unique
  passwordHash String  @map("password_hash")
  phone        String?
  cpf          String?
  role         Role    @default(USER)
  avatar       String?

  storeId String?
  store   Store?  @relation(fields: [storeId], references: [id])

  street     String?
  cityId     String?
  city       City?   @relation(fields: [cityId], references: [id])
  state      String?
  postalCode String? @map("postal_code")

  createdAt DateTime @default(now()) @map("createdAt")

  orders            Order[]
  carts             Cart[]
  cashbacks         Cashback[]
  cashbackTx        CashbackTransaction[]
  refreshTokens     RefreshToken[]
  locations         UserLocation[]
  checkIns          CheckIn[]
  missionProgresses MissionProgress[]
  couponRedemptions CouponRedemption[]
  evaluations       StoreEvaluation[]

  @@map("users")
}

///////////////////////////////////////////////////////////////
// PLANS & SUBSCRIPTIONS (MARKETPLACE SaaS)
///////////////////////////////////////////////////////////////

model Plan {
  id           String   @id @default(uuid())
  name         String
  price        Decimal
  productLimit Int
  storeLimit   Int
  userLimit    Int
  description  String?
  createdAt    DateTime @default(now()) @map("createdAt")

  subscriptions Subscription[]
}

model Subscription {
  id        String             @id @default(uuid())
  storeId   String             @map("store_id")
  store     Store              @relation(fields: [storeId], references: [id])
  planId    String             @map("plan_id")
  plan      Plan               @relation(fields: [planId], references: [id])
  status    SubscriptionStatus @default(ACTIVE)
  startAt   DateTime           @default(now()) @map("start_at")
  endAt     DateTime           @map("end_at")
  renewedAt DateTime?          @map("renewed_at")
  createdAt DateTime           @default(now()) @map("createdAt")

  @@map("subscriptions")
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  EXPIRED
}

///////////////////////////////////////////////////////////////
// BUSINESS CATEGORIES
///////////////////////////////////////////////////////////////

model BusinessCategory {
  id        String   @id @default(uuid())
  name      String
  image     String?
  createdAt DateTime @default(now()) @map("createdAt")

  cities BusinessCategoryCity[]
  stores StoreBusinessCategory[]

  @@unique([name])
  @@map("business_categories")
}

model BusinessCategoryCity {
  id                 String @id @default(uuid())
  businessCategoryId String @map("business_categoryId")
  cityId             String @map("city_id")

  businessCategory BusinessCategory @relation(fields: [businessCategoryId], references: [id], onDelete: Cascade)
  city             City             @relation(fields: [cityId], references: [id], onDelete: Cascade)

  @@unique([businessCategoryId, cityId])
  @@map("business_category_cities")
}

model StoreBusinessCategory {
  id         String @id @default(uuid())
  storeId    String @map("store_id")
  categoryId String @map("categoryId")

  store    Store            @relation(fields: [storeId], references: [id], onDelete: Cascade)
  category BusinessCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([storeId, categoryId])
  @@map("store_business_categories")
}

///////////////////////////////////////////////////////////////
// STORES
///////////////////////////////////////////////////////////////

model Store {
  id          String   @id @default(uuid())
  name        String
  slug        String?  @unique
  isActive    Boolean  @default(true)
  rating      Float    @default(0)
  ratingCount Int      @default(0)
  latitude    Decimal
  longitude   Decimal
  phone       String?
  cnpj        String?
  avatar      String?
  street      String?
  postalCode  String?  @map("postal_code")
  cityId      String   @map("city_id")
  city        City     @relation(fields: [cityId], references: [id])
  createdAt   DateTime @default(now()) @map("createdAt")

  products       Product[]
  orders         Order[]
  carts          Cart[]
  users          User[]
  subscriptions  Subscription[]
  paymentTypes   PaymentType[]
  evaluations    StoreEvaluation[]
  cashbacks      Cashback[]
  cashbackTx     CashbackTransaction[]
  coupons        Coupon[]
  storeDiscounts StoreDiscount[]
  banners        Banner[]
  checkIns       CheckIn[]

  storeCategories         StoreCategory[]
  storeBusinessCategories StoreBusinessCategory[]

  @@map("stores")
}

///////////////////////////////////////////////////////////////
// CATEGORIES & SUBCATEGORIES
///////////////////////////////////////////////////////////////

model Category {
  id        String   @id @default(uuid())
  name      String
  image     String?
  createdAt DateTime @default(now()) @map("createdAt")

  subcategories SubCategory[]
  stores        StoreCategory[]

  @@unique([name])
  @@map("categories")
}

model SubCategory {
  id         String   @id @default(uuid())
  name       String
  image      String?
  categoryId String   @map("categoryId")
  category   Category @relation(fields: [categoryId], references: [id])
  createdAt  DateTime @default(now()) @map("createdAt")

  products Product[]

  @@map("subcategories")
}

model StoreCategory {
  id         String @id @default(uuid())
  storeId    String @map("store_id")
  categoryId String @map("categoryId")

  store    Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([storeId, categoryId])
  @@map("store_categories")
}

///////////////////////////////////////////////////////////////
// PRODUCTS
///////////////////////////////////////////////////////////////

model Product {
  id                 String  @id @default(uuid())
  name               String
  description        String?
  price              Decimal
  quantity           Decimal
  minStock           Int     @default(5)
  image              String?
  status             Boolean @default(true)
  cashbackPercentage Float   @default(0.0) @map("cashback_percentage")

  storeId       String      @map("store_id")
  store         Store       @relation(fields: [storeId], references: [id])
  subcategoryId String      @map("subcategoryId")
  subcategory   SubCategory @relation(fields: [subcategoryId], references: [id])

  orderItems OrderItem[]
  cartItems  CartItem[]

  createdAt DateTime @default(now()) @map("createdAt")

  @@map("products")
}

///////////////////////////////////////////////////////////////
// CART & CART ITEMS
///////////////////////////////////////////////////////////////

model Cart {
  id        String     @id @default(uuid())
  userId    String     @map("userId")
  storeId   String     @map("store_id")
  status    CartStatus @default(OPEN)
  createdAt DateTime   @default(now()) @map("createdAt")
  updatedAt DateTime   @updatedAt @map("updated_at")

  user  User  @relation(fields: [userId], references: [id])
  store Store @relation(fields: [storeId], references: [id])

  items CartItem[]

  @@map("carts")
}

enum CartStatus {
  OPEN
  CHECKED_OUT
  CLOSED
}

model CartItem {
  id               String   @id @default(uuid())
  cartId           String   @map("cart_id")
  productId        String   @map("product_id")
  quantity         Int
  priceSnapshot    Decimal  @map("price_snapshot")
  cashbackSnapshot Decimal  @map("cashback_snapshot")
  createdAt        DateTime @default(now()) @map("createdAt")

  cart    Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@unique([cartId, productId])
  @@map("cart_items")
}

///////////////////////////////////////////////////////////////
// ORDERS
///////////////////////////////////////////////////////////////

model Order {
  id              String      @id @default(uuid())
  userId          String      @map("userId")
  storeId         String      @map("store_id")
  totalAmount     Decimal     @map("total_amount")
  discountApplied Decimal     @default(0) @map("discount_applied")
  validatedAt     DateTime?   @map("validated_at")
  qrCodeUrl       String?
  status          OrderStatus @default(PENDING)
  createdAt       DateTime    @default(now()) @map("createdAt")

  user  User  @relation(fields: [userId], references: [id])
  store Store @relation(fields: [storeId], references: [id])

  items             OrderItem[]
  cashbacks         Cashback[]
  cashbackTx        CashbackTransaction[]
  couponRedemptions CouponRedemption[]

  @@map("orders")
}

model OrderItem {
  id        String  @id @default(uuid())
  orderId   String  @map("orderId")
  productId String  @map("product_id")
  quantity  Decimal
  subtotal  Decimal

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@map("order_items")
}

///////////////////////////////////////////////////////////////
// CASHBACK
///////////////////////////////////////////////////////////////

model Cashback {
  id         String         @id @default(uuid())
  userId     String         @map("userId")
  storeId    String         @map("store_id")
  orderId    String?
  amount     Decimal
  validated  Boolean        @default(false)
  creditedAt DateTime
  status     CashbackStatus @default(PENDING)

  user  User   @relation(fields: [userId], references: [id])
  store Store  @relation(fields: [storeId], references: [id])
  order Order? @relation(fields: [orderId], references: [id])

  @@map("cashbacks")
}

model CashbackTransaction {
  id        String                  @id @default(uuid())
  userId    String                  @map("userId")
  storeId   String                  @map("store_id")
  orderId   String?
  amount    Decimal
  type      CashbackTransactionType
  createdAt DateTime                @default(now()) @map("createdAt")

  user  User   @relation(fields: [userId], references: [id])
  store Store  @relation(fields: [storeId], references: [id])
  order Order? @relation(fields: [orderId], references: [id])

  @@map("cashback_transactions")
}

enum CashbackStatus {
  PENDING
  CONFIRMED
  CANCELED
}

enum CashbackTransactionType {
  RECEIVE
  USE
}

///////////////////////////////////////////////////////////////
// BANNERS, COUPONS, DISCOUNTS, MISSIONS, CHECK-IN, AUTH
///////////////////////////////////////////////////////////////

model Banner {
  id       String  @id @default(uuid())
  title    String
  imageUrl String
  link     String?
  isActive Boolean @default(true)
  position Int?
  storeId  String

  store     Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("createdAt")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("banners")
}

model Reel {
  id         String   @id @default(uuid())
  title      String
  image_url  String
  link       String?
  createdAt  DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("reels")
}

model CheckIn {
  id        String   @id @default(uuid())
  userId    String   @map("userId")
  storeId   String   @map("store_id")
  latitude  Float?
  longitude Float?
  createdAt DateTime @default(now()) @map("createdAt")

  user  User  @relation(fields: [userId], references: [id])
  store Store @relation(fields: [storeId], references: [id])

  @@map("checkins")
}

model Coupon {
  id         String     @id @default(uuid())
  code       String     @unique
  storeId    String     @map("store_id")
  type       CouponType
  value      Decimal
  minValue   Decimal?
  usageLimit Int?
  usedCount  Int        @default(0)
  validFrom  DateTime
  validTo    DateTime
  isActive   Boolean    @default(true)
  createdAt  DateTime   @default(now()) @map("createdAt")
  updatedAt  DateTime   @updatedAt @map("updated_at")

  store       Store              @relation(fields: [storeId], references: [id])
  redemptions CouponRedemption[]

  @@map("coupons")
}

model CouponRedemption {
  id       String  @id @default(uuid())
  couponId String  @map("coupon_id")
  userId   String  @map("userId")
  orderId  String?

  coupon Coupon @relation(fields: [couponId], references: [id])
  user   User   @relation(fields: [userId], references: [id])
  order  Order? @relation(fields: [orderId], references: [id])

  createdAt DateTime @default(now()) @map("createdAt")

  @@map("coupon_redemptions")
}

model StoreDiscount {
  id          String       @id @default(uuid())
  storeId     String       @map("store_id")
  type        DiscountType
  value       Decimal
  title       String?
  description String?
  validFrom   DateTime?
  validTo     DateTime?
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now()) @map("createdAt")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  store Store @relation(fields: [storeId], references: [id])

  @@map("store_discounts")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @map("userId")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("createdAt")

  user User @relation(fields: [userId], references: [id])

  @@map("refresh_tokens")
}

model UserLocation {
  id        String   @id @default(uuid())
  userId    String   @map("userId")
  latitude  Float
  longitude Float
  createdAt DateTime @default(now()) @map("createdAt")

  user User @relation(fields: [userId], references: [id])

  @@map("user_locations")
}

model Mission {
  id          String      @id @default(uuid())
  title       String
  description String?
  type        MissionType
  target      Int
  rewardType  RewardType
  rewardValue Decimal?
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now()) @map("createdAt")

  progresses MissionProgress[]

  @@map("missions")
}

model MissionProgress {
  id          String    @id @default(uuid())
  missionId   String    @map("mission_id")
  userId      String    @map("userId")
  progress    Int       @default(0)
  completed   Boolean   @default(false)
  completedAt DateTime?
  createdAt   DateTime  @default(now()) @map("createdAt")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  mission Mission @relation(fields: [missionId], references: [id])
  user    User    @relation(fields: [userId], references: [id])

  @@unique([missionId, userId])
  @@map("mission_progresses")
}

model StoreEvaluation {
  id        String   @id @default(uuid())
  storeId   String   @map("store_id")
  userId    String   @map("userId")
  rating    Int
  createdAt DateTime @default(now()) @map("createdAt")

  store Store @relation(fields: [storeId], references: [id])
  user  User  @relation(fields: [userId], references: [id])

  @@unique([storeId, userId])
  @@map("store_evaluations")
}

model PaymentType {
  id        String   @id @default(uuid())
  type      String
  createdAt DateTime @default(now()) @map("createdAt")

  stores Store[]

  @@map("payment_types")
}

///////////////////////////////////////////////////////////////
// ENUMS
///////////////////////////////////////////////////////////////

enum Role {
  USER
  ADMIN
}

enum OrderStatus {
  PENDING
  VALIDATED
  EXPIRED
}

enum DiscountType {
  FIXED
  DAILY
  WEEKLY
}

enum CouponType {
  PERCENT
  FIXED
  CONDITIONAL
}

enum MissionType {
  CHECKIN
  ORDERS_COUNT
  ORDERS_VALUE
  COUPONS_USED
}

enum RewardType {
  COUPON
  DISCOUNT
}
